<html>
    <head></head>
    <body>
        

<style>

    table#root {
        width: 100%;
        height: 100%;
        border: 1px solid black;
    }

    table#stuffs {
        width: 100%;
    }

    
    th, td {
        border: 1px solid black;
    }
    #wt {
        height: 50%;
    }

    #stuff {
        width: 40%;
    }
    h3 {
        text-align: center;
        margin-left: auto;
        margin-right: auto;
    }
    img {
        border: 1px solid black;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
</style>

<table id="root">
    <tr>
        <td rowspan="2" id="stuff">
            <table id="stuffs">
                <tr>
                    <td>물건 상태</td>
                    <td>정리</td>
                </tr>
                <tr>
                    <td colspan="2" id="stf"></td>
                </tr>
            </table>
        </td>
        <td id="cal">

            <img id="qr">
        </td>
    </tr>
    <tr>
        <td id="wt"> 
            <img/>
            <h3></h3>
        </td>
    </tr>
</table>


<!-- <div id="wt"></div>
<div id="cal"></div>
<div id="stf"></div> -->

<!-- 800 x 480 -->
<script>
    function getQueryVariable(variable) {
        const query = window.location.search.substring(1);
        const vars = query.split('&');
        for (let i = 0; i < vars.length; i++) {
            const pair = vars[i].split('=');
            if (decodeURIComponent(pair[0]) == variable) {
                return decodeURIComponent(pair[1]);
            }
        }
        return undefined;
    }
    const ws = new WebSocket(`ws://${getQueryVariable('ip')}:${getQueryVariable('ws')}`);

    ws.onopen = function(event) {
        ws.send(JSON.stringify({ type: 'weather' }));
        ws.send(JSON.stringify({ type: 'stuffs', action: 'read' }));
        ws.send(JSON.stringify({ type: 'today' }));
        // TODO: send these interval
    };

    ws.onmessage = function (event) {
        const msg = JSON.parse(event.data);
        // msg.type === stuff, weather, today
        // ws.send("hi");
        if (msg.type === 'today') {
            if (msg.data.code === 1) {
                document.querySelector("#qr").src = msg.data.data;
            } else {
                const { items } = JSON.parse(msg.data);
                // 모든 item 나열
                document.querySelector("#cal").innerHTML += '오늘의 일정: ' + items[0].summary;
            }
            return;
        }
        if (msg.type === 'weather') {
            const weather = JSON.parse(event.data).data;
            const { temp_min, temp_max } = weather.main;
            const { main, icon } = weather.weather[0];
            document.querySelector("#wt > img").src = `https://openweathermap.org/img/wn/${icon}@2x.png`;
            document.querySelector("#wt > h3").innerHTML = `${main} | ${Math.round(temp_min - 273)}°C/${Math.round(temp_max - 273)}°C`;
            return;
        }
        document.querySelector("#stf").innerHTML += event.data;
    };
</script>

</body>
</html>